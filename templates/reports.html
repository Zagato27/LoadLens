<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Отчёт</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;0,600;0,700;1,600&display=swap" rel="stylesheet">
  <style>
    body { background: #121212; color: #fff; font-family: 'Montserrat', Arial, sans-serif; margin: 0; }
    .container { width: 90%; max-width: 1400px; margin: 0 auto; padding: 16px; }
    h2 { margin: 8px 0 16px; }
    a { color: #9bbcff; text-decoration: none; }
    .app-header { position: sticky; top: 0; display: flex; align-items: center; justify-content: flex-start; gap: 12px; z-index: 2000; width: 100%; max-width: 1400px; margin: 0 auto; padding: 8px 12px; --brandSize: 40px; background: #121212; border-bottom: 1px solid #2a2a2a; }
    .app-header .logo { width: var(--brandSize); height: var(--brandSize); object-fit: contain; }
    .app-header .brand { font-size: var(--brandSize); line-height: var(--brandSize); font-weight: 600; font-style: italic; letter-spacing: 0.2px; color: #eaeaea; }
    .app-nav { display: flex; gap: 16px; margin-left: auto; flex-wrap: nowrap; white-space: nowrap; }
    .app-nav a.nav-btn { height: 36px; padding: 8px 4px; background: transparent; border: none; color: #eaeaea; border-bottom: 2px solid transparent; border-radius: 0; cursor: pointer; font-family: 'Montserrat', Arial, sans-serif; font-weight: 600; font-style: italic; text-decoration: none; display: inline-flex; align-items: center; }
    .app-nav { align-items: center; }
    .pa-select { height: 36px; padding: 0 10px; background: #2b2b2b; border: 1px solid #444; border-radius: 6px; color: #eaeaea; font-family: 'Montserrat', Arial, sans-serif; font-weight: 600; font-style: italic; font-size: 14px; }
    .app-nav a.nav-btn:hover { color: #ffffff; border-bottom-color: #3700b3; }
    .app-nav a.nav-btn.active { color: #ffffff; border-bottom-color: #6200ee; }

    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    select, button { padding: 8px; background: #2b2b2b; color: #fff; border: 1px solid #444; border-radius: 6px; font-family: 'Montserrat', Arial, sans-serif; font-size: 14px; }
    select, button { height: 40px; }
    h1, h2, h3, h4 { font-weight: 600; font-style: italic; }
    #repRunInfo { font-size: 18px; font-weight: 600; }

    .app-nav-inner { display:flex; gap: 16px; margin: 8px 0; }
    .nav-btn { height: 36px; padding: 8px 4px; background: transparent; border: none; color: #eaeaea; border-bottom: 2px solid transparent; border-radius: 0; cursor: pointer; font-family: 'Montserrat', Arial, sans-serif; font-weight: 600; font-style: italic; }
    .nav-btn.active { border-bottom-color: #6200ee; color: #fff; }
    .panel { display: none; }
    .panel.active { display: block; }

    .cmp-chart-wrap { background: #0f0f0f; border: 1px solid #333; border-radius: 6px; padding: 10px; margin-top: 12px; display: flex; gap: 12px; }
    .cmp-chart-canvas { flex: 1; min-width: 0; }
    .cmp-legend-panel { width: 360px; max-width: 45%; background: #1b1b1b; border-left: 1px solid #333; border-radius: 6px; padding: 10px; overflow-y: auto; overflow-x: hidden; white-space: normal; min-height: 160px; }
    .cmp-legend-panel h4 { margin: 0 0 8px; font-weight: normal; color: #ddd; }
    .cmp-legend-table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; display: table; }
    .cmp-legend-table thead { display: table-header-group; }
    .cmp-legend-table tbody { display: table-row-group; }
    .cmp-legend-table tr { display: table-row; }
    .cmp-legend-table th, .cmp-legend-table td { display: table-cell; border-bottom: 1px solid #2a2a2a; padding: 6px 8px; text-align: left; white-space: normal; word-break: break-word; }
    .cmp-legend-color { width: 14px; height: 14px; border-radius: 3px; display: inline-block; margin-right: 6px; vertical-align: middle; border: 1px solid #444; }

    .custom-select-wrapper { position: relative; display: block; background-color: #2b2b2b; color: #ffffff; border: 1px solid #444; border-radius: 4px; margin-top: 5px; cursor: pointer; }
    .custom-select { padding: 8px; position: relative; }
    .custom-options { position: absolute; top: 100%; left: 0; right: 0; background-color: #2b2b2b; border: 1px solid #444; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
    .custom-option { padding: 8px; cursor: pointer; border-bottom: 1px solid #444; }
    .custom-option:last-child { border-bottom: none; }
    .custom-option:hover { background-color: #444; }
    .custom-select-wrapper.open .custom-options { display: block; }
    /* Адаптив: легенда под графиком на узких экранах */
    @media (max-width: 900px) {
      .cmp-chart-wrap { flex-wrap: wrap; }
      .cmp-legend-panel { width: 100%; max-width: none; }
    }
    /* Hover-подсветка кнопок легенды */
    .cmp-legend-controls button { background: #2b2b2b; border: 1px solid #444; color: #fff; transition: background-color 0.2s ease, border-color 0.2s ease; }
    .cmp-legend-controls button:hover { background: #3700b3; border-color: #6200ee; }
    /* Editor: Итоги от инженера */
    .editor-card { background:#1e1e1e; border:1px solid #333; border-radius:6px; padding:12px; margin-top:16px; }
    .editor-toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .editor-toolbar button { height:32px; padding:0 10px; background:#2b2b2b; color:#fff; border:1px solid #444; border-radius:6px; cursor:pointer; }
    .editor-toolbar button:hover { background:#3700b3; border-color:#6200ee; }
    .editor-area { min-height:140px; background:#0f0f0f; border:1px solid #333; border-radius:6px; padding:10px; outline:none; }
    .editor-actions { display:flex; gap:8px; margin-top:10px; }
    .btn-primary { background:#6200ee; border:1px solid #6200ee; }
    .btn-primary:hover { background:#3700b3; border-color:#3700b3; }
  </style>
</head>
<body>
  <div class="app-header">
    <img class="logo" src="/assets/logo.png" alt="LoadLens" />
    <span class="brand">LoadLens</span>
    <div class="app-nav">
      <select id="projectAreaSelect" class="pa-select">
        <option value="">Все области</option>
      </select>
      <a class="nav-btn" href="/">Дэшборд</a>
      <a class="nav-btn" href="/new">Новый отчёт</a>
      <a class="nav-btn active" href="/reports">Архив</a>
      <a class="nav-btn" href="/compare">Сравнение тестов</a>
      <a class="nav-btn" href="/settings">Настройки</a>
    </div>
  </div>
  <div class="container">
    <h1 id="pageTitle">Отчет по тесту</h1>
    <div id="pageTimeRange" style="margin:6px 0 12px 0; font-size:14px; color:#bbb;">Время теста: —</div>
    <div id="engineerBox" class="editor-card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
        <h3 style="margin:0;">Итоги от инженера</h3>
        <div style="display:flex; align-items:center; gap:8px;">
          <small id="engineerUpdated" style="color:#aaa;"></small>
          <button type="button" id="editEngineer">Редактировать</button>
        </div>
      </div>
      <div class="editor-toolbar" id="engineerToolbar" style="display:none;">
        <button type="button" data-cmd="bold"><b>B</b></button>
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="insertUnorderedList">• Список</button>
        <button type="button" data-cmd="insertOrderedList">1. Список</button>
        <button type="button" data-cmd="h3">H3</button>
        <button type="button" data-cmd="h4">H4</button>
        <button type="button" id="cmdLink">Ссылка</button>
      </div>
      <div id="engineerEditor" class="editor-area" contenteditable="false" spellcheck="false"></div>
      <div class="editor-actions">
        <button type="button" id="saveEngineer" class="btn-primary" style="display:none;">Сохранить</button>
        <span id="engineerStatus" style="color:#bbb; font-size:13px;"></span>
      </div>
    </div>
    <div id="rep-llm-tabs" style="margin:12px 0;"></div>
    <div id="rep-domain-tabs"></div>
  </div>

  <script>
    // Chart background plugin
    const cmpBgPlugin = { id:'cmpBg', beforeDraw(chart, args, opts){ const {ctx, chartArea} = chart; if(!chartArea) return; ctx.save(); ctx.fillStyle = (opts&&opts.color)||'#151515'; ctx.fillRect(chartArea.left, chartArea.top, chartArea.right-chartArea.left, chartArea.bottom-chartArea.top); ctx.restore(); } };
    if (window.Chart && Chart.register) Chart.register(cmpBgPlugin);

    function randColor(alpha=0.7){ const r=Math.floor(100+Math.random()*155); const g=Math.floor(100+Math.random()*155); const b=Math.floor(100+Math.random()*155); return `rgba(${r},${g},${b},${alpha})`; }

    async function reportsLoadRuns(){ const sel=document.getElementById('repRunSelect'); sel.innerHTML=''; try{ sel.disabled = true; const o=document.createElement('option'); o.value=''; o.textContent='Загрузка…'; sel.appendChild(o);}catch(e){} const runs=await (await fetch('/runs')).json(); sel.innerHTML=''; runs.forEach(r=>{ const o=document.createElement('option'); o.value=r.run_name; o.textContent=r.run_name; sel.appendChild(o); }); try{ sel.disabled = false; }catch(e){} }
    let _schemaCache=null; async function reportsLoadSchema(){ _schemaCache = await (await fetch('/domains_schema')).json(); }

    function renderLlmParsedToMarkdown(report, scores){
      const safe=(x)=> (x===undefined||x===null)?'':String(x).trim();
      const standardizeVerdict=(vRaw)=>{
        const v=(safe(vRaw)||'').toLowerCase();
        if(!v) return 'Недостаточно данных';
        const ok=['ok','okay','успех','успешно','success','passed','green'];
        const warn=['warn','warning','есть риски','риски','risk','risks','degrad','degraded','предупреждение'];
        const crit=['critical','критично','fail','failed','ошибка','error','red','провал'];
        const na=['insufficient','нет данных','недостаточно','no data','unknown','n/a'];
        if(ok.some(x=>v.includes(x))) return 'Успешно';
        if(warn.some(x=>v.includes(x))) return 'Есть риски';
        if(crit.some(x=>v.includes(x))) return 'Провал';
        if(na.some(x=>v.includes(x))) return 'Недостаточно данных';
        return 'Недостаточно данных';
      };
      const lines=[];
      const verdict=standardizeVerdict((report||{}).verdict||'');
      // Доверие: используем оценку судьи overall
      let judgeOverall = undefined;
      try{ if(scores && scores.judge && typeof scores.judge.overall==='number'){ judgeOverall = scores.judge.overall; } }catch(e){}
      const confStr = (typeof judgeOverall==='number' && isFinite(judgeOverall)) ? `${Math.round(judgeOverall*100)}%` : '—';
      lines.push('### Итог LLM');
      lines.push(`- Вердикт: ${verdict}`);
      lines.push(`- Доверие: ${confStr}`);
      lines.push('');
      const peak=(report||{}).peak_performance||(report||{}).peak_perfomance;
      if(peak&&typeof peak==='object'){
        const max_rps=safe(peak.max_rps),max_time=safe(peak.max_time),drop_time=safe(peak.drop_time),method=safe(peak.method);
        if(max_rps||max_time||drop_time||method){
          lines.push('#### Пиковая производительность');
          if(max_rps) lines.push(`- Максимальный RPS: ${max_rps}`);
          if(max_time) lines.push(`- Время пика: ${max_time}`);
          if(drop_time) lines.push(`- Время деградации: ${drop_time}`);
          if(method) lines.push(`- Метод оценки: ${method}`);
          lines.push('');
        }
      }
      const findings=(report||{}).findings||[];
      lines.push('#### Ключевые находки');
      if(!findings.length){ lines.push('- Нет существенных находок'); }
      else { findings.forEach(f=>{ if(f&&typeof f==='object'){ const summary=safe(f.summary); const sev=safe(f.severity),comp=safe(f.component),ev=safe(f.evidence); const meta=[]; if(sev) meta.push(`severity: ${sev}`); if(comp) meta.push(`component: ${comp}`); if(ev) meta.push(`evidence: ${ev}`); const metaStr=meta.join('; '); lines.push(metaStr?`- ${summary} (${metaStr})`:`- ${summary}`); } else { lines.push(`- ${safe(f)}`); } }); }
      const actions=(report||{}).recommended_actions||(report||{}).actions||[];
      lines.push('');
      lines.push('#### Рекомендации');
      if(!actions.length){ lines.push('- Нет рекомендаций'); }
      else { actions.forEach(a=>{ const s=safe(a); if(s) lines.push(`- ${s}`); }); }
      const affected=(report||{}).affected_components||[];
      if(affected&&affected.length){ lines.push(''); lines.push('#### Затронутые компоненты'); lines.push(affected.map(x=>`\`${safe(x)}\``).join(', ')); }
      return lines.join('\n');
    }
    function pct(x){ try{ if(x===undefined||x===null) return '—'; const v=Number(x); if(!isFinite(v)) return '—'; return `${Math.round(v*100)}%`; }catch(e){ return '—'; } }
    function judgeMarkdown(scores){ try{ const s=scores||{}; const j=(s.judge)||{}; const overall=j.overall,factual=j.factual,completeness=j.completeness,specificity=j.specificity; const dataScore=s.data_score,finalScore=s.final_score,conf=s.confidence; const lines=['','#### Доверие (судья)']; lines.push(`- Итог: ${pct(overall)}`); lines.push(`- Согласованность (factual): ${pct(factual)}`); lines.push(`- Полнота (completeness): ${pct(completeness)}`); lines.push(`- Конкретика (specificity): ${pct(specificity)}`); lines.push(`- По данным: ${pct(dataScore)}`); lines.push(`- Агрегат: ${pct(finalScore)}`); if(typeof conf==='number') lines.push(`- Доверие модели: ${pct(conf)}`); lines.push(''); lines.push('_Пояснения: итог = 0.6·factual + 0.3·completeness + 0.2·specificity._'); return '\n'+lines.join('\n'); }catch(e){ return ''; } }

    function getRunFromPath(){
      try{
        const parts=location.pathname.split('/').filter(Boolean);
        const idx=parts.indexOf('reports');
        if(idx>=0){
          // ожидаем /reports/{service}/{run}
          if(parts[idx+2]) return decodeURIComponent(parts[idx+2]);
          if(parts[idx+1]) return decodeURIComponent(parts[idx+1]);
        }
      }catch(e){}
      return null;
    }
    async function reportsLoadLlm(){ const run=getRunFromPath(); if(!run) return; const box=document.getElementById('rep-llm-tabs'); box.textContent='Загрузка…'; const resp=await fetch('/llm_reports?run_name='+encodeURIComponent(run)); let arr=await resp.json(); try{ const title=document.getElementById('pageTitle'); if(title) title.textContent = `Отчет по тесту ${run}`; const list=(Array.isArray(arr)?arr:[]); const starts=list.map(x=>parseInt(x.start_ms,10)).filter(v=>Number.isFinite(v)); const ends=list.map(x=>parseInt(x.end_ms,10)).filter(v=>Number.isFinite(v)); let startStr='—', endStr='—'; if(starts.length){ const ms=Math.min.apply(null,starts); const d=new Date(ms); const yyyy=d.getFullYear(); const MM=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); startStr=`${yyyy}-${MM}-${dd} ${hh}:${mm}`; } if(ends.length){ const me=Math.max.apply(null,ends); const de=new Date(me); const yyyy=de.getFullYear(); const MM=String(de.getMonth()+1).padStart(2,'0'); const dd=String(de.getDate()).padStart(2,'0'); const hh=String(de.getHours()).padStart(2,'0'); const mm=String(de.getMinutes()).padStart(2,'0'); endStr=`${yyyy}-${MM}-${dd} ${hh}:${mm}`; } const range=document.getElementById('pageTimeRange'); if(range) range.textContent = `Время теста: ${startStr} - ${endStr}`; }catch(e){}
      if(!Array.isArray(arr)){ box.textContent='Нет данных'; return; }
      // На всякий случай отфильтруем домен engineer, даже если бэкенд уже его исключил
      arr = arr.filter(x=> (x && x.domain && x.domain !== 'engineer'));
      const domainsOrder=['final','jvm','database','kafka','microservices','hard_resources','lt_framework'];
      arr.sort((a,b)=> domainsOrder.indexOf(a.domain)-domainsOrder.indexOf(b.domain));
      const tabsNav=document.createElement('div'); tabsNav.className='app-nav-inner'; const tabsBody=document.createElement('div'); const idBase='rep-llm-tab-'; arr.forEach((x,idx)=>{ const btn=document.createElement('button'); btn.className='nav-btn'+(idx===0?' active':''); btn.textContent=(x.domain==='final'?'Итог':x.domain); btn.dataset.target=idBase+idx; tabsNav.appendChild(btn); const pane=document.createElement('div'); pane.id=idBase+idx; pane.className='panel'+(idx===0?' active':''); let md=''; let sc=x?x.scores:null; if(sc&&typeof sc==='string'){ try{ sc=JSON.parse(sc);}catch(e){} } try{ let parsed=x?x.parsed:null; if(parsed&&typeof parsed==='string'){ try{ parsed=JSON.parse(parsed);}catch(e){} } if(parsed&&typeof parsed==='object'){ md=renderLlmParsedToMarkdown(parsed, sc);} else { const raw=String(x&&x.text?x.text:''); let fallbackParsed=null; if(raw.trim().startsWith('{')){ try{ fallbackParsed=JSON.parse(raw);}catch(e){} } if(!fallbackParsed && raw.includes('"verdict"')){ try{ const start=raw.indexOf('{'); const end=raw.lastIndexOf('}'); if(start>=0&&end>start){ fallbackParsed=JSON.parse(raw.slice(start,end+1)); } }catch(e){} } md=(fallbackParsed&&typeof fallbackParsed==='object')?renderLlmParsedToMarkdown(fallbackParsed, sc):raw; } }catch(e){ md=String(x&&x.text?x.text:''); } try{ md+=judgeMarkdown(sc);}catch(e){} let html=(window.marked && typeof marked.parse==='function')? marked.parse(md): md; try{ if(window.DOMPurify) html=DOMPurify.sanitize(html);}catch(e){} pane.innerHTML=`<div style="background:#1e1e1e; border:1px solid #333; border-radius:6px; padding:12px;">${html}</div>`; tabsBody.appendChild(pane); }); box.innerHTML=''; box.appendChild(tabsNav); box.appendChild(tabsBody); tabsNav.querySelectorAll('.nav-btn').forEach(btn=>{ btn.addEventListener('click',()=>{ tabsNav.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); tabsBody.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); btn.classList.add('active'); const t=btn.dataset.target; const pane=tabsBody.querySelector('#'+t); if(pane) pane.classList.add('active'); setTimeout(syncLegends, 0); }); }); }

    function reportsDefaultSeriesKey(domain){ if(domain==='kafka') return 'client_id'; if(domain==='database') return 'service'; if(domain==='hard_resources') return 'node'; if(domain==='lt_framework') return 'scenario'; return 'application'; }
    async function reportsRenderDomains(){ const run=getRunFromPath(); if(!run) return; const root=document.getElementById('rep-domain-tabs'); root.innerHTML='Загрузка…'; const domains=Object.keys(_schemaCache||{}); const tabsNav=document.createElement('div'); tabsNav.className='app-nav-inner'; const tabsBody=document.createElement('div'); const idBase='rep-dom-tab-'; domains.forEach((domain,di)=>{ const btn=document.createElement('button'); btn.className='nav-btn'+(di===0?' active':''); btn.textContent=domain; btn.dataset.target=idBase+di; tabsNav.appendChild(btn); const pane=document.createElement('div'); pane.id=idBase+di; pane.className='panel'+(di===0?' active':''); const list=(_schemaCache[domain]||[]).map(x=>x.query_label); list.forEach((ql,qi)=>{ const wrap=document.createElement('div'); wrap.className='cmp-chart-wrap'; wrap.style.marginTop='12px'; const canvasBox=document.createElement('div'); canvasBox.className='cmp-chart-canvas'; const title=document.createElement('div'); title.style.padding='8px 0'; title.style.fontWeight='600'; title.textContent=ql; const cnv=document.createElement('canvas'); cnv.id=`rep-chart-${di}-${qi}`; cnv.height=120; canvasBox.appendChild(title); canvasBox.appendChild(cnv); const legend=document.createElement('div'); legend.className='cmp-legend-panel'; legend.innerHTML='<h4>Легенда</h4><div class="cmp-legend-controls"><button class="hideAll">Выключить все</button><button class="showAll">Включить все</button><button class="downloadPng">Скачать PNG</button></div><div class="table"></div>'; wrap.appendChild(canvasBox); wrap.appendChild(legend); pane.appendChild(wrap); setTimeout(async()=>{ await reportsDrawOne(run, domain, ql, cnv.id, legend); }, 0); }); tabsBody.appendChild(pane); }); root.innerHTML=''; root.appendChild(tabsNav); root.appendChild(tabsBody); tabsNav.querySelectorAll('.nav-btn').forEach(btn=>{ btn.addEventListener('click',()=>{ tabsNav.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); tabsBody.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); btn.classList.add('active'); const t=btn.dataset.target; const pane=tabsBody.querySelector('#'+t); if(pane) pane.classList.add('active'); setTimeout(syncLegends, 0); }); }); if(!domains.length){ root.textContent='Нет данных'; } }
    async function reportsDrawOne(run, domain, ql, canvasId, legendRoot){
      const u=new URL('/run_series', location.origin);
      u.searchParams.set('run_name', run);
      u.searchParams.set('domain', domain);
      u.searchParams.set('query_label', ql);
      u.searchParams.set('series_key', 'auto');
      u.searchParams.set('align','absolute');
      const resp=await fetch(u);
      const data=await resp.json();
      if(!data||!data.points||!data.points.length){
        try{ const tbl=legendRoot.querySelector('.table'); if(tbl) tbl.innerHTML='Нет данных'; }catch(e){}
        return;
      }
      const labels=[]; const map={};
      data.points.forEach(p=>{
        const t=p.t; // ISO datetime
        if(labels.indexOf(t)<0) labels.push(t);
        const k=p.series; if(!map[k]) map[k]=new Map();
        map[k].set(t, p.value);
      });
      labels.sort((a,b)=> new Date(a) - new Date(b));
      const datasets=Object.keys(map).map(k=>{ const color=randColor(); return {label:k, data:labels.map(t=> map[k].has(t)?map[k].get(t):null), borderColor:color, backgroundColor:color, pointRadius:0, borderWidth:2, spanGaps:true}; });
      const ctx=document.getElementById(canvasId).getContext('2d');
      const chart=new Chart(ctx,{
        type:'line',
        data:{labels, datasets},
        options:{
          responsive:true,
          interaction:{mode:'nearest', intersect:false},
          plugins:{ legend:{display:false}, cmpBg:{ color:'#151515'} },
          scales:{
            x:{
              title:{display:true, text:'Время', color:'#ccc'},
              ticks:{
                color:'#bbb',
                callback:function(value){
                  const raw=this.getLabelForValue(value);
                  const d=new Date(raw);
                  const hh=String(d.getHours()).padStart(2,'0');
                  const mm=String(d.getMinutes()).padStart(2,'0');
                  return `${hh}:${mm}`;
                }
              },
              grid:{color:'#2f2f2f', drawBorder:true, borderColor:'#444'}
            },
            y:{ ticks:{color:'#bbb'}, grid:{color:'#2f2f2f', drawBorder:true, borderColor:'#444'} }
          }
        }
      });
      try{ legendRoot.dataset.domain = domain; legendRoot.dataset.queryLabel = ql; }catch(e){}
      buildLegendFor(chart, legendRoot);
      try{
        const canvasEl=document.getElementById(canvasId);
        legendRoot.style.height='auto';
        const rect=canvasEl.getBoundingClientRect();
        const attrH=(canvasEl.height || parseInt(canvasEl.getAttribute('height')||'0',10)) || 0;
        const h=Math.max(160, Math.floor((rect && rect.height) || attrH || 0));
        legendRoot.style.height=h+'px';
        if (window.requestAnimationFrame) requestAnimationFrame(()=>{
          const rect2=canvasEl.getBoundingClientRect();
          const attrH2=(canvasEl.height || parseInt(canvasEl.getAttribute('height')||'0',10)) || 0;
          const h2=Math.max(160, Math.floor((rect2 && rect2.height) || attrH2 || 0));
          legendRoot.style.height=h2+'px';
        });
      }catch(e){}
    }
    // Экспорт: график + легенда в один PNG
    function downloadChartWithLegend(currentChart, root){ if(!currentChart) return null; const canvas=currentChart.canvas; const chartW=canvas.width; const chartH=canvas.height; const rows=(currentChart.data?.datasets||[]).map((ds,i)=>{ const vals=(ds.data||[]).filter(v=>v!=null&&!isNaN(v)); const avg=vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length):0; return { idx:i, label:ds.label, color:ds.borderColor, avg:avg, visible: currentChart.isDatasetVisible(i)}; }).filter(r=>r.visible); const pad=16, rowH=24, titleH=22, hdrH=rows.length?(titleH+10):0; const legendH=rows.length?(hdrH+rows.length*rowH+pad):0; const outH=chartH + (legendH? (legendH+pad):0); const out=document.createElement('canvas'); out.width=chartW; out.height=outH; const ctx=out.getContext('2d'); ctx.fillStyle='#0f0f0f'; ctx.fillRect(0,0,out.width,out.height); ctx.drawImage(canvas,0,0); if(rows.length){ let y=chartH+pad; ctx.fillStyle='#ddd'; ctx.font='16px Montserrat, Arial, sans-serif'; ctx.fillText('Легенда', pad, y); y+=titleH; ctx.font='13px Montserrat, Arial, sans-serif'; rows.forEach(r=>{ ctx.fillStyle=r.color||'#888'; ctx.fillRect(pad, y-12, 14, 14); ctx.strokeStyle='#444'; ctx.strokeRect(pad, y-12, 14, 14); ctx.fillStyle='#ddd'; const label=String(r.label||''); ctx.fillText(label, pad+20, y); const avgStr=Number.isFinite(r.avg)? r.avg.toFixed(2):'—'; const right=out.width-pad; const text=`Среднее: ${avgStr}`; const tw=ctx.measureText(text).width; ctx.fillText(text, right-tw, y); y+=rowH; }); } const nameParts=[]; try{ const d=root?.dataset?.domain; if(d) nameParts.push(d); const q=root?.dataset?.queryLabel; if(q) nameParts.push(q); }catch(e){} const a=document.createElement('a'); a.href=out.toDataURL('image/png'); a.download=`report-${(nameParts.join('-')||'chart')}.png`; document.body.appendChild(a); a.click(); a.remove(); return true; }
    let repLegendSortBy='avg'; let repLegendSortDir='desc';
    function buildLegendFor(chart, root){ const box=root.querySelector('.table'); if(!box) return; box.innerHTML=''; const tbl=document.createElement('table'); tbl.className='cmp-legend-table'; const thead=document.createElement('thead'); thead.innerHTML='<tr><th data-sort="name" style="cursor:pointer">Серия</th><th>Цвет</th><th data-sort="avg" style="cursor:pointer">Среднее</th><th>Вкл</th></tr>'; tbl.appendChild(thead); const tbody=document.createElement('tbody'); let rows=(chart?.data?.datasets||[]).map((ds,i)=>{ const vals=(ds.data||[]).filter(v=>v!=null&&!isNaN(v)); const avg=vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length):0; return { idx:i, label:ds.label, color:ds.borderColor, avg:avg, visible: chart.isDatasetVisible(i)}; }); rows.sort((a,b)=> repLegendSortBy==='name' ? (repLegendSortDir==='asc'? a.label.localeCompare(b.label): b.label.localeCompare(a.label)) : (repLegendSortDir==='asc'? (a.avg-b.avg):(b.avg-a.avg)) ); rows.forEach(row=>{ const tr=document.createElement('tr'); tr.className='cmp-legend-row'+(row.visible?'':' hidden'); const tdName=document.createElement('td'); tdName.textContent=row.label; const tdColor=document.createElement('td'); const sw=document.createElement('span'); sw.className='cmp-legend-color'; sw.style.background=row.color; tdColor.appendChild(sw); const tdAvg=document.createElement('td'); tdAvg.textContent=isFinite(row.avg)? row.avg.toFixed(2):'—'; const tdToggle=document.createElement('td'); tdToggle.textContent=row.visible?'✓':'✕'; tr.appendChild(tdName); tr.appendChild(tdColor); tr.appendChild(tdAvg); tr.appendChild(tdToggle); tr.addEventListener('click',()=>{ const vis=chart.isDatasetVisible(row.idx); chart.setDatasetVisibility(row.idx, !vis); chart.update(); buildLegendFor(chart, root); }); tbody.appendChild(tr); }); tbl.appendChild(tbody); box.appendChild(tbl); thead.addEventListener('click',(e)=>{ const th=e.target.closest('[data-sort]'); if(!th) return; const by=th.getAttribute('data-sort'); if(repLegendSortBy===by){ repLegendSortDir=(repLegendSortDir==='asc')?'desc':'asc'; } else { repLegendSortBy=by; repLegendSortDir=(by==='avg')?'desc':'asc'; } buildLegendFor(chart, root); }); const hideBtn=root.querySelector('.hideAll'); const showBtn=root.querySelector('.showAll'); if (hideBtn) hideBtn.onclick=()=>{ for(let i=0;i<chart.data.datasets.length;i++){ chart.setDatasetVisibility(i,false);} chart.update(); buildLegendFor(chart, root); }; if (showBtn) showBtn.onclick=()=>{ for(let i=0;i<chart.data.datasets.length;i++){ chart.setDatasetVisibility(i,true);} chart.update(); buildLegendFor(chart, root); }; const dlBtn=root.querySelector('.downloadPng'); if (dlBtn) dlBtn.onclick=()=>{ downloadChartWithLegend(chart, root); }; }
    function syncLegends(){
      try{
        const doSync = ()=>{
          document.querySelectorAll('.cmp-chart-wrap').forEach(w=>{
            const canvas=w.querySelector('canvas');
            const legend=w.querySelector('.cmp-legend-panel');
            if(!canvas||!legend) return;
            // Сначала сброс, затем измерение и установка
            legend.style.height = 'auto';
            const rect=canvas.getBoundingClientRect();
            const h = Math.max(160, Math.floor((rect && rect.height) || 0));
            legend.style.height = h + 'px';
          });
        };
        doSync();
        // Повторяем на следующий кадр — после того как Chart.js завершит ресайз
        if (window.requestAnimationFrame) requestAnimationFrame(()=> doSync());
      }catch(e){}
    }
    window.addEventListener('resize', syncLegends);

    async function reportsInit(){ await reportsLoadSchema(); await reportsLoadLlm(); await reportsRenderDomains(); }
    async function initProjectArea(){
      try{
        const sel=document.getElementById('projectAreaSelect'); if(!sel) return;
        const services=await (await fetch('/services')).json();
        sel.innerHTML='<option value="">Все области</option>' + (services||[]).map(s=>`<option value="${s}">${s}</option>`).join('');
        const cur=await (await fetch('/current_project_area')).json();
        const val=(cur&&cur.project_area)||''; sel.value=val||'';
        sel.addEventListener('change', async()=>{ try{ await fetch('/project_area', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ service: sel.value })}); location.reload(); }catch(e){} });
      }catch(e){}
    }
    async function engineerLoad(){
      try{
        const run=getRunFromPath(); if(!run) return;
        const r=await fetch('/engineer_summary?run_name='+encodeURIComponent(run));
        if(!r.ok) return;
        const j=await r.json();
        const ed=document.getElementById('engineerEditor');
        const updated=document.getElementById('engineerUpdated');
        let html=String(j.content_html||'');
        try{ if(window.DOMPurify) html = DOMPurify.sanitize(html); }catch(e){}
        ed.innerHTML = html || '<p style="color:#888">Добавьте итоговый комментарий…</p>';
        updated.textContent = j.created_at ? ('Обновлено: '+j.created_at.replace('T',' ').slice(0,16)) : '';
      }catch(e){}
    }
    function editorExec(cmd, val){
      try{
        if(cmd==='h3' || cmd==='h4'){
          document.execCommand('formatBlock', false, cmd.toUpperCase()); return;
        }
        document.execCommand(cmd, false, val||null);
      }catch(e){}
    }
    (function(){
      const tb=document.getElementById('engineerToolbar');
      if(tb){
        tb.addEventListener('click', (e)=>{
          const btn=e.target.closest('button'); if(!btn) return;
          const cmd=btn.getAttribute('data-cmd'); if(cmd) editorExec(cmd);
        });
      }
      const linkBtn=document.getElementById('cmdLink');
      if(linkBtn){ linkBtn.addEventListener('click', ()=>{ const url=prompt('URL ссылки:','https://'); if(url){ editorExec('createLink', url); } }); }
      const saveBtn=document.getElementById('saveEngineer');
      const editBtn=document.getElementById('editEngineer');
      const editor=document.getElementById('engineerEditor');
      function setEngineerEditing(on){
        try{
          if(editor) editor.setAttribute('contenteditable', on ? 'true' : 'false');
          if(tb) tb.style.display = on ? '' : 'none';
          if(saveBtn) saveBtn.style.display = on ? '' : 'none';
          if(editBtn) editBtn.textContent = on ? 'Завершить' : 'Редактировать';
        }catch(e){}
      }
      if(editBtn){ editBtn.addEventListener('click', ()=>{
        const isOn = editor && editor.getAttribute('contenteditable') === 'true';
        setEngineerEditing(!isOn);
      }); }
      // По умолчанию режим просмотра
      setEngineerEditing(false);
      if(saveBtn){ saveBtn.addEventListener('click', async()=>{
        const run=getRunFromPath(); if(!run) return;
        const html=document.getElementById('engineerEditor').innerHTML;
        const st=document.getElementById('engineerStatus');
        st.textContent='Сохранение…';
        try{
          const resp=await fetch('/engineer_summary', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ run_name: run, content_html: html }) });
          const j=await resp.json();
          if(resp.ok){ st.textContent='Сохранено'; setEngineerEditing(false); await engineerLoad(); setTimeout(()=>{ st.textContent=''; }, 1500); }
          else { st.textContent=j.error||'Ошибка сохранения'; }
        }catch(e){ st.textContent='Ошибка сохранения'; }
      }); }
    })();
    (async function(){ await initProjectArea(); await reportsInit(); await engineerLoad(); })();
  </script>
</body>
</html>


