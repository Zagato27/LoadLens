<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Отчёт</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;0,600;0,700;1,600&display=swap" rel="stylesheet">
  <style>
    body { background: #121212; color: #fff; font-family: 'Montserrat', Arial, sans-serif; margin: 0; }
    .container { width: 90%; max-width: 1400px; margin: 0 auto; padding: 16px; }
    h2 { margin: 8px 0 16px; }
    a { color: #9bbcff; text-decoration: none; }
    .app-header { position: sticky; top: 0; display: flex; align-items: center; justify-content: flex-start; gap: 12px; z-index: 2000; width: 100%; max-width: 1400px; margin: 0 auto; padding: 8px 12px; --brandSize: 40px; background: #121212; border-bottom: 1px solid #2a2a2a; }
    .app-header .logo { width: var(--brandSize); height: var(--brandSize); object-fit: contain; }
    .app-header .brand { font-size: var(--brandSize); line-height: var(--brandSize); font-weight: 600; font-style: italic; letter-spacing: 0.2px; color: #eaeaea; }
    .app-nav { display: flex; gap: 16px; margin-left: auto; flex-wrap: nowrap; white-space: nowrap; }
    .app-nav a.nav-btn { height: 36px; padding: 8px 4px; background: transparent; border: none; color: #eaeaea; border-bottom: 2px solid transparent; border-radius: 0; cursor: pointer; font-family: 'Montserrat', Arial, sans-serif; font-weight: 600; font-style: italic; text-decoration: none; display: inline-flex; align-items: center; }
    .app-nav { align-items: center; }
    .pa-select { height: 36px; padding: 0 10px; background: #2b2b2b; border: 1px solid #444; border-radius: 6px; color: #eaeaea; font-family: 'Montserrat', Arial, sans-serif; font-weight: 600; font-style: italic; font-size: 14px; }
    .app-nav a.nav-btn:hover { color: #ffffff; border-bottom-color: #3700b3; }
    .app-nav a.nav-btn.active { color: #ffffff; border-bottom-color: #6200ee; }

    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    select, button { padding: 8px; background: #2b2b2b; color: #fff; border: 1px solid #444; border-radius: 6px; font-family: 'Montserrat', Arial, sans-serif; font-size: 14px; }
    select, button { height: 40px; }
    h1, h2, h3, h4 { font-weight: 600; font-style: italic; }
    #repRunInfo { font-size: 18px; font-weight: 600; }

    .app-nav-inner { display:flex; gap: 16px; margin: 8px 0; }
    .nav-btn { height: 36px; padding: 8px 4px; background: transparent; border: none; color: #eaeaea; border-bottom: 2px solid transparent; border-radius: 0; cursor: pointer; font-family: 'Montserrat', Arial, sans-serif; font-weight: 600; font-style: italic; }
    .nav-btn.active { border-bottom-color: #6200ee; color: #fff; }
    .panel { display: none; }
    .panel.active { display: block; }

    .cmp-chart-wrap { background: #0f0f0f; border: 1px solid #333; border-radius: 6px; padding: 10px; margin-top: 12px; display: flex; gap: 12px; }
    .cmp-chart-canvas { flex: 1; min-width: 0; }
    .cmp-legend-panel { width: 480px; max-width: 55%; background: #1b1b1b; border-left: 1px solid #333; border-radius: 6px; padding: 10px; overflow-y: auto; overflow-x: hidden; white-space: normal; min-height: 160px; }
    .cmp-legend-panel h4 { margin: 0 0 8px; font-weight: normal; color: #ddd; }
    .cmp-legend-table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; display: table; }
    .cmp-legend-table thead { display: table-header-group; }
    .cmp-legend-table tbody { display: table-row-group; }
    .cmp-legend-table tr { display: table-row; }
    .cmp-legend-table th, .cmp-legend-table td { display: table-cell; border-bottom: 1px solid #2a2a2a; padding: 6px 8px; text-align: left; white-space: normal; word-break: break-word; }
    .cmp-legend-color { width: 14px; height: 14px; border-radius: 3px; display: inline-block; margin-right: 6px; vertical-align: middle; border: 1px solid #444; }

    .custom-select-wrapper { position: relative; display: block; background-color: #2b2b2b; color: #ffffff; border: 1px solid #444; border-radius: 4px; margin-top: 5px; cursor: pointer; }
    .custom-select { padding: 8px; position: relative; }
    .custom-options { position: absolute; top: 100%; left: 0; right: 0; background-color: #2b2b2b; border: 1px solid #444; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
    .custom-option { padding: 8px; cursor: pointer; border-bottom: 1px solid #444; }
    .custom-option:last-child { border-bottom: none; }
    .custom-option:hover { background-color: #444; }
    .custom-select-wrapper.open .custom-options { display: block; }
    /* Адаптив: легенда под графиком на узких экранах */
    @media (max-width: 900px) {
      .cmp-chart-wrap { flex-wrap: wrap; }
      .cmp-legend-panel { width: 100%; max-width: none; }
    }
    /* Hover-подсветка кнопок легенды */
    .cmp-legend-controls button { background: #2b2b2b; border: 1px solid #444; color: #fff; transition: background-color 0.2s ease, border-color 0.2s ease; }
    .cmp-legend-controls button:hover { background: #3700b3; border-color: #6200ee; }
    /* Editor: Итоги от инженера */
    .editor-card { background:#1e1e1e; border:1px solid #333; border-radius:6px; padding:12px; margin-top:16px; }
    .editor-toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .editor-toolbar button { height:32px; padding:0 10px; background:#2b2b2b; color:#fff; border:1px solid #444; border-radius:6px; cursor:pointer; }
    .editor-toolbar button:hover { background:#3700b3; border-color:#6200ee; }
    .editor-area { min-height:140px; background:#0f0f0f; border:1px solid #333; border-radius:6px; padding:10px; outline:none; }
    .editor-actions { display:flex; gap:8px; margin-top:10px; }
    .btn-primary { background:#6200ee; border:1px solid #6200ee; }
    .btn-primary:hover { background:#3700b3; border-color:#3700b3; }
    /* Ширины колонок легенды: больше места под 'Серия' */
    .cmp-legend-table th:nth-child(1), .cmp-legend-table td:nth-child(1) { width: 66%; }
    .cmp-legend-table th:nth-child(2), .cmp-legend-table td:nth-child(2) { width: 56px; }
    .cmp-legend-table th:nth-child(3), .cmp-legend-table td:nth-child(3) { width: 24%; }
    .cmp-legend-table th:nth-child(4), .cmp-legend-table td:nth-child(4) { width: 40px; }
  </style>
</head>
<body>
  <div class="app-header">
    <img class="logo" src="/assets/logo.png" alt="LoadLens" />
    <span class="brand">LoadLens</span>
    <div class="app-nav">
      <select id="projectAreaSelect" class="pa-select">
        <option value="">Все области</option>
      </select>
      <a class="nav-btn" href="/">Дэшборд</a>
      <a class="nav-btn" href="/new">Новый отчёт</a>
      <a class="nav-btn active" href="/reports">Архив</a>
      <a class="nav-btn" href="/compare">Сравнение тестов</a>
      <a class="nav-btn" href="/settings">Настройки</a>
    </div>
  </div>
  <div class="container">
    <h1 id="pageTitle">Отчет по тесту</h1>
    <div id="pageTimeRange" style="margin:6px 0 12px 0; font-size:14px; color:#bbb;">Время теста: —</div>
    <div id="engineerBox" class="editor-card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
        <h3 style="margin:0;">Итоги от инженера</h3>
        <div style="display:flex; align-items:center; gap:8px;">
          <small id="engineerUpdated" style="color:#aaa;"></small>
          <button type="button" id="editEngineer">Редактировать</button>
        </div>
      </div>
      <div class="editor-toolbar" id="engineerToolbar" style="display:none;">
        <button type="button" data-cmd="bold"><b>B</b></button>
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="insertUnorderedList">• Список</button>
        <button type="button" data-cmd="insertOrderedList">1. Список</button>
        <button type="button" data-cmd="h3">H3</button>
        <button type="button" data-cmd="h4">H4</button>
        <button type="button" id="cmdLink">Ссылка</button>
      </div>
      <div id="engineerEditor" class="editor-area" contenteditable="false" spellcheck="false"></div>
      <div class="editor-actions">
        <button type="button" id="saveEngineer" class="btn-primary" style="display:none;">Сохранить</button>
        <span id="engineerStatus" style="color:#bbb; font-size:13px;"></span>
      </div>
    </div>
    <div id="rep-llm-tabs" style="margin:12px 0;"></div>
    <div id="rep-domain-tabs"></div>
  </div>

  <script>
    // Chart background plugin
    const cmpBgPlugin = { id:'cmpBg', beforeDraw(chart, args, opts){ const {ctx, chartArea} = chart; if(!chartArea) return; ctx.save(); ctx.fillStyle = (opts&&opts.color)||'#151515'; ctx.fillRect(chartArea.left, chartArea.top, chartArea.right-chartArea.left, chartArea.bottom-chartArea.top); ctx.restore(); } };
    if (window.Chart && Chart.register) Chart.register(cmpBgPlugin);

    function randColor(alpha=0.7){ const r=Math.floor(100+Math.random()*155); const g=Math.floor(100+Math.random()*155); const b=Math.floor(100+Math.random()*155); return `rgba(${r},${g},${b},${alpha})`; }

    async function reportsLoadRuns(){ const sel=document.getElementById('repRunSelect'); sel.innerHTML=''; try{ sel.disabled = true; const o=document.createElement('option'); o.value=''; o.textContent='Загрузка…'; sel.appendChild(o);}catch(e){} const runs=await (await fetch('/runs')).json(); sel.innerHTML=''; runs.forEach(r=>{ const o=document.createElement('option'); o.value=r.run_name; o.textContent=r.run_name; sel.appendChild(o); }); try{ sel.disabled = false; }catch(e){} }
    let _schemaCache=null; async function reportsLoadSchema(){ _schemaCache = await (await fetch('/domains_schema')).json(); }

    function renderLlmParsedToMarkdown(report, scores){
      const safe=(x)=> (x===undefined||x===null)?'':String(x).trim();
      const standardizeVerdict=(vRaw)=>{
        const v=(safe(vRaw)||'').toLowerCase();
        if(!v) return 'Недостаточно данных';
        const ok=['ok','okay','успех','успешно','success','passed','green'];
        const warn=['warn','warning','есть риски','риски','risk','risks','degrad','degraded','предупреждение'];
        const crit=['critical','критично','fail','failed','ошибка','error','red','провал'];
        const na=['insufficient','нет данных','недостаточно','no data','unknown','n/a'];
        if(ok.some(x=>v.includes(x))) return 'Успешно';
        if(warn.some(x=>v.includes(x))) return 'Есть риски';
        if(crit.some(x=>v.includes(x))) return 'Провал';
        if(na.some(x=>v.includes(x))) return 'Недостаточно данных';
        return 'Недостаточно данных';
      };
      const lines=[];
      const verdict=standardizeVerdict((report||{}).verdict||'');
      // Доверие: используем оценку судьи overall
      let judgeOverall = undefined;
      try{ if(scores && scores.judge && typeof scores.judge.overall==='number'){ judgeOverall = scores.judge.overall; } }catch(e){}
      const confStr = (typeof judgeOverall==='number' && isFinite(judgeOverall)) ? `${Math.round(judgeOverall*100)}%` : '—';
      lines.push('### Итог LLM');
      lines.push(`- Вердикт: ${verdict}`);
      lines.push(`- Доверие: ${confStr}`);
      lines.push('');
      const peak=(report||{}).peak_performance||(report||{}).peak_perfomance;
      if(peak&&typeof peak==='object'){
        const max_rps=safe(peak.max_rps),max_time=safe(peak.max_time),drop_time=safe(peak.drop_time),method=safe(peak.method);
        if(max_rps||max_time||drop_time||method){
          lines.push('#### Пиковая производительность');
          if(max_rps) lines.push(`- Максимальный RPS: ${max_rps}`);
          if(max_time) lines.push(`- Время пика: ${max_time}`);
          if(drop_time) lines.push(`- Время деградации: ${drop_time}`);
          if(method) lines.push(`- Метод оценки: ${method}`);
          lines.push('');
        }
      }
      const findings=(report||{}).findings||[];
      lines.push('#### Ключевые находки');
      if(!findings.length){ lines.push('- Нет существенных находок'); }
      else { findings.forEach(f=>{ if(f&&typeof f==='object'){ const summary=safe(f.summary); const sev=safe(f.severity),comp=safe(f.component),ev=safe(f.evidence); const meta=[]; if(sev) meta.push(`severity: ${sev}`); if(comp) meta.push(`component: ${comp}`); if(ev) meta.push(`evidence: ${ev}`); const metaStr=meta.join('; '); lines.push(metaStr?`- ${summary} (${metaStr})`:`- ${summary}`); } else { lines.push(`- ${safe(f)}`); } }); }
      const actions=(report||{}).recommended_actions||(report||{}).actions||[];
      lines.push('');
      lines.push('#### Рекомендации');
      if(!actions.length){ lines.push('- Нет рекомендаций'); }
      else { actions.forEach(a=>{ const s=safe(a); if(s) lines.push(`- ${s}`); }); }
      const affected=(report||{}).affected_components||[];
      if(affected&&affected.length){ lines.push(''); lines.push('#### Затронутые компоненты'); lines.push(affected.map(x=>`\`${safe(x)}\``).join(', ')); }
      return lines.join('\n');
    }
    function pct(x){ try{ if(x===undefined||x===null) return '—'; const v=Number(x); if(!isFinite(v)) return '—'; return `${Math.round(v*100)}%`; }catch(e){ return '—'; } }
    function judgeMarkdown(scores){ try{ const s=scores||{}; const j=(s.judge)||{}; const overall=j.overall,factual=j.factual,completeness=j.completeness,specificity=j.specificity; const dataScore=s.data_score,finalScore=s.final_score,conf=s.confidence; const lines=['','#### Доверие (судья)']; lines.push(`- Итог: ${pct(overall)}`); lines.push(`- Согласованность (factual): ${pct(factual)}`); lines.push(`- Полнота (completeness): ${pct(completeness)}`); lines.push(`- Конкретика (specificity): ${pct(specificity)}`); lines.push(`- По данным: ${pct(dataScore)}`); lines.push(`- Агрегат: ${pct(finalScore)}`); if(typeof conf==='number') lines.push(`- Доверие модели: ${pct(conf)}`); lines.push(''); lines.push('_Пояснения: итог = 0.6·factual + 0.3·completeness + 0.2·specificity._'); return '\n'+lines.join('\n'); }catch(e){ return ''; } }

    function getRunFromPath(){
      try{
        const parts=location.pathname.split('/').filter(Boolean);
        const idx=parts.indexOf('reports');
        if(idx>=0){
          // ожидаем /reports/{service}/{run}
          if(parts[idx+2]) return decodeURIComponent(parts[idx+2]);
          if(parts[idx+1]) return decodeURIComponent(parts[idx+1]);
        }
      }catch(e){}
      return null;
    }
  </script>
  <script defer src="/static/js/common.js"></script>
  <script defer src="/static/js/reports.js"></script>
</body>
</html>


