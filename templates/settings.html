<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Настройки</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;0,600;0,700;1,600&display=swap" rel="stylesheet">
  <style>
    body { background:#121212; color:#fff; font-family:'Montserrat', Arial, sans-serif; margin:0; }
    .app-header { position:sticky; top:0; display:flex; align-items:center; gap:12px; z-index:2000; width:100%; max-width:1400px; margin:0 auto; padding:8px 12px; --brandSize:40px; background:#121212; border-bottom:1px solid #2a2a2a; }
    .app-header .logo { width:var(--brandSize); height:var(--brandSize); object-fit:contain; }
    .app-header .brand { font-size:var(--brandSize); line-height:var(--brandSize); font-weight:600; font-style:italic; letter-spacing:.2px; color:#eaeaea; }
    .app-nav { display:flex; gap:16px; margin-left:auto; white-space:nowrap; align-items:center; }
    .app-nav a.nav-btn { height:36px; padding:8px 4px; background:transparent; border:none; color:#eaeaea; border-bottom:2px solid transparent; cursor:pointer; font-weight:600; font-style:italic; text-decoration:none; display:inline-flex; align-items:center; }
    .app-nav a.nav-btn:hover { color:#fff; border-bottom-color:#3700b3; }
    .app-nav a.nav-btn.active { color:#fff; border-bottom-color:#6200ee; }
    .container { width:90%; max-width:1400px; margin:16px auto; }
    h2 { margin:8px 0 16px; font-weight:600; font-style:italic; }
    details { background:#1e1e1e; border:1px solid #333; border-radius:8px; margin-bottom:10px; }
    summary { cursor:pointer; padding:10px 12px; font-weight:600; outline:none; }
    .panel { padding: 0 12px 12px 12px; }
    .editor-wrap { border:1px solid #333; border-radius:8px; background:#0f0f0f; margin:8px 0 10px 0; overflow:hidden; }
    .editor-header { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; background:#151515; border-bottom:1px solid #333; }
    .editor-title { font-weight:600; color:#ddd; font-size:13px; }
    .editor-status { color:#bbb; font-size:12px; }
    .editor { width:100%; min-height:240px; background:#0f0f0f; }
    .help { color:#bbbbbb; font-size:13px; line-height:1.5; margin: 8px 0 10px 0; }
    .btn { height:36px; padding:0 12px; background:#6200ee; border:1px solid #6200ee; color:#fff; border-radius:6px; cursor:pointer; margin-top:8px; }
    .btn-secondary { background:#2b2b2b; border:1px solid #444; }
    .btn:hover { background:#3700b3; border-color:#3700b3; }
    .row { display:flex; gap:8px; align-items:center; }
    .status { color:#bbb; font-size:13px; margin-left:8px; }
  </style>
</head>
<body>
  <div class="app-header">
    <img class="logo" src="/assets/logo.png" alt="LoadLens" />
    <span class="brand">LoadLens</span>
    <div class="app-nav">
      <a class="nav-btn" href="/">Дэшборд</a>
      <a class="nav-btn" href="/new">Новый отчёт</a>
      <a class="nav-btn" href="/reports">Архив</a>
      <a class="nav-btn" href="/compare">Сравнение тестов</a>
      <a class="nav-btn active" href="/settings">Настройки</a>
    </div>
  </div>
  <div class="container">
    <h2>Настройки</h2>
    <div class="row" style="margin:8px 0 14px 0; gap:12px; align-items:center;">
      <label for="areaSelect" style="min-width:160px; color:#ccc;">Проектная область:</label>
      <select id="areaSelect" style="height:36px; background:#1e1e1e; color:#eaeaea; border:1px solid #333; border-radius:6px; padding:6px 10px; min-width:200px;"></select>
      <button class="btn btn-secondary" id="addAreaBtn" type="button">Добавить область</button>
      <span id="areaStatus" class="status"></span>
    </div>

    <details open>
      <summary>Конфигурация отчётов в LoadLens</summary>
      <div class="panel">
        <details>
          <summary>LLM</summary>
          <div class="panel">
            <div class="help">Настройка провайдера LLM (perplexity/openai/anthropic), параметры генерации, таймауты и параллелизм. Изменения применяются сразу к новым отчётам.</div>
            <div class="editor-wrap">
              <div class="editor-header"><div class="editor-title">JSON</div><span class="editor-status status" id="st_llm"></span></div>
              <div id="ed_llm" class="editor"></div>
            </div>
            <div class="row"><button class="btn btn-secondary" data-edit="llm">Редактировать</button><button class="btn" data-save="llm" style="display:none;">Сохранить</button></div>
          </div>
        </details>
        <details>
          <summary>Источник метрик</summary>
          <div class="panel">
            <div class="help">Выберите режим: <code>prometheus</code> (прямое подключение) или <code>grafana_proxy</code> (через Grafana). Укажите URL Prometheus или базовый URL Grafana и параметры доступа/датасорса.</div>
            <div class="editor-wrap">
              <div class="editor-header"><div class="editor-title">JSON</div><span class="editor-status status" id="st_metrics_source"></span></div>
              <div id="ed_metrics_source" class="editor"></div>
            </div>
            <div class="row"><button class="btn btn-secondary" data-edit="metrics_source">Редактировать</button><button class="btn" data-save="metrics_source" style="display:none;">Сохранить</button></div>
          </div>
        </details>
    <details>
      <summary>Источник метрик LT (нагрузочное ПО)</summary>
      <div class="panel">
        <div class="help">Конфигурация чтения метрик самого инструмента нагрузочного тестирования (lt_framework): <code>prometheus</code> (прямо), <code>grafana_proxy</code> или <code>influxdb</code> (прямое подключение к InfluxDB v2).</div>
        <div class="editor-wrap">
          <div class="editor-header"><div class="editor-title">JSON</div><span class="editor-status status" id="st_lt_metrics_source"></span></div>
          <div id="ed_lt_metrics_source" class="editor"></div>
        </div>
        <div class="row"><button class="btn btn-secondary" data-edit="lt_metrics_source">Редактировать</button><button class="btn" data-save="lt_metrics_source" style="display:none;">Сохранить</button></div>
      </div>
    </details>
        <details>
          <summary>Хранилище (TimescaleDB)</summary>
          <div class="panel">
            <div class="help">Параметры подключения TimescaleDB, имена таблиц (<code>metrics</code>, <code>llm_reports</code>, <code>engineer_reports</code>), батч и настройки гипертаблицы.</div>
            <div class="editor-wrap">
              <div class="editor-header"><div class="editor-title">JSON</div><span class="editor-status status" id="st_storage_timescale"></span></div>
              <div id="ed_storage_timescale" class="editor"></div>
            </div>
            <div class="row"><button class="btn btn-secondary" data-edit="storage.timescale">Редактировать</button><button class="btn" data-save="storage.timescale" style="display:none;">Сохранить</button></div>
          </div>
        </details>
        <details>
          <summary>Параметры по умолчанию</summary>
          <div class="panel">
            <div class="help">Шаг выборки (<code>step</code>) и интервал ресемплинга (<code>resample_interval</code>) для агрегации временных рядов.</div>
            <div class="editor-wrap">
              <div class="editor-header"><div class="editor-title">JSON</div><span class="editor-status status" id="st_default_params"></span></div>
              <div id="ed_default_params" class="editor"></div>
            </div>
            <div class="row"><button class="btn btn-secondary" data-edit="default_params">Редактировать</button><button class="btn" data-save="default_params" style="display:none;">Сохранить</button></div>
          </div>
        </details>
        <details>
          <summary>Запросы</summary>
          <div class="panel">
            <div class="help">
              <p>Домены и запросы для формирования отчёта.</p>
              <ul>
                <li><code>promql_queries</code>/<code>label_keys_list</code>/<code>labels</code> — для источника Prometheus или Grafana Proxy.</li>
                <li><code>flux_queries</code>/<code>label_tag_keys_list</code>/<code>labels</code> — для источника InfluxDB (Flux). В Flux допускаются плейсхолдеры <code>{bucket}</code>, <code>{start}</code>, <code>{end}</code> (ISO8601 UTC).</li>
              </ul>
              <p>Домен <code>lt_framework</code> — метрики инструмента нагрузочного тестирования:</p>
              <ul>
                <li>Prometheus: задайте <code>promql_queries</code> (например, RPS и p95 по <code>scenario</code>), <code>label_keys_list</code>, <code>labels</code>.</li>
                <li>InfluxDB: задайте <code>flux_queries</code> с <code>from(bucket: \"{bucket}\") |> range(start: {start}, stop: {end})</code>, укажите теги для серий в <code>label_tag_keys_list</code> и подписи в <code>labels</code>.</li>
                <li>Рекомендуется использовать тег <code>scenario</code> как основной ключ серии.</li>
              </ul>
            </div>
            <div class="editor-wrap">
              <div class="editor-header"><div class="editor-title">JSON</div><span class="editor-status status" id="st_queries"></span></div>
              <div id="ed_queries" class="editor"></div>
            </div>
            <div class="row"><button class="btn btn-secondary" data-edit="queries">Редактировать</button><button class="btn" data-save="queries" style="display:none;">Сохранить</button></div>
          </div>
        </details>
        <details>
          <summary>Промпты для LLM отчёта</summary>
          <div class="panel">
            <div class="help">Редактируйте тексты подсказок (prompts) для разных доменов анализа. Эти значения могут отличаться по проектным областям.</div>
            <details>
              <summary>overall</summary>
              <div class="panel">
                <div class="editor-wrap">
                  <div class="editor-header"><div class="editor-title">Prompt: overall</div><span class="editor-status status" id="st_prompt_overall"></span></div>
                  <div id="ed_prompt_overall" class="editor"></div>
                </div>
                <div class="row"><button class="btn btn-secondary" data-prompt-edit="overall">Редактировать</button><button class="btn" data-prompt-save="overall" style="display:none;">Сохранить</button></div>
              </div>
            </details>
            <details>
              <summary>judge</summary>
              <div class="panel">
                <div class="editor-wrap">
                  <div class="editor-header"><div class="editor-title">Prompt: judge</div><span class="editor-status status" id="st_prompt_judge"></span></div>
                  <div id="ed_prompt_judge" class="editor"></div>
                </div>
                <div class="row"><button class="btn btn-secondary" data-prompt-edit="judge">Редактировать</button><button class="btn" data-prompt-save="judge" style="display:none;">Сохранить</button></div>
              </div>
            </details>
            <details>
              <summary>critic</summary>
              <div class="panel">
                <div class="editor-wrap">
                  <div class="editor-header"><div class="editor-title">Prompt: critic</div><span class="editor-status status" id="st_prompt_critic"></span></div>
                  <div id="ed_prompt_critic" class="editor"></div>
                </div>
                <div class="row"><button class="btn btn-secondary" data-prompt-edit="critic">Редактировать</button><button class="btn" data-prompt-save="critic" style="display:none;">Сохранить</button></div>
              </div>
            </details>
            <details>
              <summary>database</summary>
              <div class="panel">
                <div class="editor-wrap">
                  <div class="editor-header"><div class="editor-title">Prompt: database</div><span class="editor-status status" id="st_prompt_database"></span></div>
                  <div id="ed_prompt_database" class="editor"></div>
                </div>
                <div class="row"><button class="btn btn-secondary" data-prompt-edit="database">Редактировать</button><button class="btn" data-prompt-save="database" style="display:none;">Сохранить</button></div>
              </div>
            </details>
            <details>
              <summary>kafka</summary>
              <div class="panel">
                <div class="editor-wrap">
                  <div class="editor-header"><div class="editor-title">Prompt: kafka</div><span class="editor-status status" id="st_prompt_kafka"></span></div>
                  <div id="ed_prompt_kafka" class="editor"></div>
                </div>
                <div class="row"><button class="btn btn-secondary" data-prompt-edit="kafka">Редактировать</button><button class="btn" data-prompt-save="kafka" style="display:none;">Сохранить</button></div>
              </div>
            </details>
            <details>
              <summary>microservices</summary>
              <div class="panel">
                <div class="editor-wrap">
                  <div class="editor-header"><div class="editor-title">Prompt: microservices</div><span class="editor-status status" id="st_prompt_microservices"></span></div>
                  <div id="ed_prompt_microservices" class="editor"></div>
                </div>
                <div class="row"><button class="btn btn-secondary" data-prompt-edit="microservices">Редактировать</button><button class="btn" data-prompt-save="microservices" style="display:none;">Сохранить</button></div>
              </div>
            </details>
            <details>
              <summary>jvm</summary>
              <div class="panel">
                <div class="editor-wrap">
                  <div class="editor-header"><div class="editor-title">Prompt: jvm</div><span class="editor-status status" id="st_prompt_jvm"></span></div>
                  <div id="ed_prompt_jvm" class="editor"></div>
                </div>
                <div class="row"><button class="btn btn-secondary" data-prompt-edit="jvm">Редактировать</button><button class="btn" data-prompt-save="jvm" style="display:none;">Сохранить</button></div>
              </div>
            </details>
            <details>
              <summary>hard_resources</summary>
              <div class="panel">
                <div class="editor-wrap">
                  <div class="editor-header"><div class="editor-title">Prompt: hard_resources</div><span class="editor-status status" id="st_prompt_hard_resources"></span></div>
                  <div id="ed_prompt_hard_resources" class="editor"></div>
                </div>
                <div class="row"><button class="btn btn-secondary" data-prompt-edit="hard_resources">Редактировать</button><button class="btn" data-prompt-save="hard_resources" style="display:none;">Сохранить</button></div>
              </div>
            </details>
          </div>
        </details>
      </div>
    </details>

    <details>
      <summary>Конфигурация отчётов в Confluence</summary>
      <div class="panel">
        <details>
          <summary>Confluence</summary>
          <div class="panel">
            <div class="help">Публикация отчёта: настройки Confluence (базовый URL, пространство, логин/пароль), а также параметры доступа к Grafana (рендер изображений панелей) и Loki (выгрузка логов).</div>
            <div class="editor-wrap">
              <div class="editor-header"><div class="editor-title">JSON</div><span class="editor-status status" id="st_confluence"></span></div>
              <div id="ed_confluence" class="editor"></div>
            </div>
            <div class="row"><button class="btn btn-secondary" data-edit="confluence">Редактировать</button><button class="btn" data-save="confluence" style="display:none;">Сохранить</button></div>
          </div>
        </details>
        <details>
          <summary>Ссылки на графики для отчётов</summary>
          <div class="panel">
            <div class="help">Перечень сервисов для публикации: ID шаблонной и родительской страницы Confluence, список метрик (панелей Grafana) и логов (Loki), используемых при сборке отчёта. Изменение структуры требует внимательности.</div>
            <div class="editor-wrap">
              <div class="editor-header"><div class="editor-title">JSON</div><span class="editor-status status" id="st_metrics_config"></span></div>
              <div id="ed_metrics_config" class="editor"></div>
            </div>
            <div class="row"><button class="btn btn-secondary" data-edit="metrics_config">Редактировать</button><button class="btn" data-save="metrics_config" style="display:none;">Сохранить</button></div>
          </div>
        </details>
      </div>
    </details>
  </div>

  <script>
/* INLINE JS DISABLED (moved to static) */
/*</script>
  <script defer src="/static/js/common.js"></script>
  <script defer src="/static/js/settings.js"></script>
</body>
</html>


